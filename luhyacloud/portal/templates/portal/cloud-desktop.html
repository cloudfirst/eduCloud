{% extends "portal/portal_template.html" %}
{% load i18n %}
{% load staticfiles %}

{% block content %}
        <!-- Page Title -->
		<div class="section section-breadcrumbs">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<h1>{{ uid }}{% trans "'s Cloud Desktop" %}</h1>
					</div>
				</div>
			</div>
		</div>

        <div class="section section-white">
	        <div class="container">
	        	<div class="row">

                    {% for vd in vds %}
	        		<div class="col-md-3 col-sm-6">
	        			<div class="service-wrapper">
		        			<img src='/static/portal/img/desktop/{{ vd.ostype }}.png'>
		        			<h3>{{ vd.name }}</h3>

		        			<p id="error_msg_{{ vd.id}}" style="display:none;"></p>

                            <div class="progress progress-striped active" id="progress_{{ vd.id }}" style="display:none">
                                <div id="progressbar_{{ vd.id }}" class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0"
                                     aria-valuemin="0" aria-valuemax="100" style="width: 0%;">0%</span>
                                </div>
                            </div>

                            <button type="button" id="run_{{ vd.id }}" onclick="startVD('{{ vd.ecid }}', '{{ vd.tid }}', '{{ vd.id }}');"  class="btn ">{% trans "Run" %}</button>

                            <div class="btn-group ">
                                <button type="button" id="show_{{ vd.id }}"  class="btn  dropdown-toggle" data-toggle="dropdown">{% trans "Show" %}<span class="caret"></span></button>
                                <ul class="dropdown-menu pull-right" role="menu">
                                    <li><a href="JavaScript:void(0);" onclick="show_in_browser( '{{ vd.tid }}' );">{% trans "Show by Browser" %}</a>
                                    </li>
                                    <li><a href="JavaScript:void(0);" onclick="show_in_tools( '{{ vd.mgr_url }}' );">{% trans "Show by windows-tool" %}</a>
                                    </li>
                                </ul>
                            </div>

                            <button type="button" id="stop_{{ vd.id }}" onclick="stop_tvd('{{ vd.tid }}', '{{ vd.tid }}' );"   class="btn ">{% trans "Stop" %}</button>

	        			</div>
	        		</div>
                    {% endfor %}

	        	</div>
	        </div>
	    </div>
{% endblock %}

{% block myjs %}
<style type="text/css">
img {
	display:inline-block;
	width:150px;
	height:120px;
	overflow:hidden;
	}
</style>

<script>
// show & set progress bar:
//  $('#progress_myvd0').css('display', 'none');
//  $('#progressbar_myvd0').css('width', '90%');
//  $('#progressbar_myvd0').text('90%');

var timer_interval = 1000;

var create_url      = "/clc/api/1.0/rvd/create/";
var start_url       = "/clc/api/1.0/rvd/start/";
var prepare_url     = "/clc/api/1.0/rvd/prepare/";
var progress_url    = "/clc/api/1.0/rvd/getprogress/";
var run_url         = "/clc/api/1.0/rvd/run/";
var stop_url        = "/clc/api/1.0/rvd/stop/" ;
var vmstatus_url    = "/clc/api/1.0/rvd/getvmstatus/";
var remove_task_url = "/clc/api/1.0/tasks/delete";

///////////////////////////////////////////////////////
//
// return :
//   sucess :  ['Result': 'OK',    'tid'   : tid]
//   failed :  ['Result': 'FAIL',  'error' : error msg]
//
///////////////////////////////////////////////////////

function create_tvd(id, srcid) {
    console.log("create_tvd() is called.");

    url = create_url + srcid;
    $.get(url,function (data) {
        items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });

        if ( items['Result'] != 'OK' ) {
            errorMsgBox(items['error']);
            return ;
        }

        taskid = items['tid'];
        setTimeout( prepare_tvd, timer_interval, id,  taskid);
    });

}

///////////////////////////////////////////////////////
//
// return :
//   sucess :  ['Result': 'OK',    'tid'   : tid]
//   failed :  ['Result': 'FAIL',  'error' : error msg]
//
///////////////////////////////////////////////////////
function start_tvd(id, taskid) {
    console.log("start_tvd() is called.");
    tmp = taskid.split(':')
    srcid = tmp[0];
    dstid = tmp[1];
    insid = tmp[2];

    url = start_url + $.trim(srcid) + "/" + $.trim(dstid) + "/" + $.trim(insid);

    $.get(url,function (data) {
        items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });

        if ( items['Result'] != 'OK' ) {
            errorMsgBox(items['error']);
            return ;
        }

        taskid = items['tid'];
        setTimeout( prepare_tvd, timer_interval, id, taskid);
    });

}

///////////////////////////////////////////////////////
//
// return :
//   sucess :  ['Result': 'OK',    'tid'   : tid]
//   failed :  ['Result': 'FAIL',  'error' : error msg]
//
///////////////////////////////////////////////////////
function prepare_tvd(id, taskid) {
    console.log("prepare_tvd() is called.");
    tmp = taskid.split(':')
    srcid = tmp[0];
    dstid = tmp[1];
    insid = tmp[2];

    url = prepare_url + $.trim(srcid) + "/" + $.trim(dstid) + "/" + $.trim(insid);


    $.getJSON(url,function (data) {
        var items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });

        if (items['Result'] != 'OK') {
            errorMsgBox(items['error']);
            return;
        }

        data['id']      = id;
        data['phase']   = 'preparing';
        data['state']   = 'downloading';
        data['tid']     = taskid,
        data['promt']   = '';
        data['errormsg']= '';
        data['failed']  = 0;
        data['progress']= 0;

        setTimeout( gui_update, timer_interval, data, 1);
    });

}

///////////////////////////////////////////////////////
//
//  return = {
//    'type': 'taskstatus',
//    'phase': "preparing",
//    'state': 'downloading',
//    'progress': 0,
//    'tid': tid,
//    'prompt': '',
//    'errormsg': '',
//    'failed' : 0
//  }
//
///////////////////////////////////////////////////////
function get_progress(id, taskid, do2run) {
    tmp = taskid.split(':')
    srcid = tmp[0];
    dstid = tmp[1];
    insid = tmp[2];
    url = progress_url + $.trim(srcid) + "/" + $.trim(dstid) + "/" + $.trim(insid);

    $.getJSON(url,function (data) {
        items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });
        console.log("get_progress() is called with progress = " + items['progress']);
        items['id'] = id;
        gui_update(items, do2run);
    });

}

///////////////////////////////////////////////////////
//
// return :
//   sucess :  ['Result': 'OK',    'tid'   : tid]
//
///////////////////////////////////////////////////////
function run_tvd(id, taskid) {
    console.log("run_tvd() is called.");

    tmp = taskid.split(':')
    srcid = tmp[0];
    dstid = tmp[1];
    insid = tmp[2];

    url = run_url + $.trim(srcid) + "/" + $.trim(dstid) + "/" + $.trim(insid);

    $.getJSON(url,function (data) {
        items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });

        data['id']      = id;
        data['phase']   = 'editing';
        data['state']   = 'booting';
        data['tid']     = taskid,
        data['promt']   = '';
        data['errormsg']= '';
        data['failed']  = 0;
        data['progress']= 0;

        setTimeout( gui_update, timer_interval, data, 0);
    });

}

///////////////////////////////////////////////////////
//
//  return = {
//        'type'    : 'taskstatus',
//        'phase'  : "editing",
//        'state'  : 'stopped', 'booting', 'running' ,
//        'tid'    : _tid,
//        'failed' : 0
//  }
//
///////////////////////////////////////////////////////
function get_vmstatus(id, taskid) {
    console.log("get_vmstatus() is called.");

    tmp = taskid.split(':')
    srcid = tmp[0];
    dstid = tmp[1];
    insid = tmp[2];

    url = vmstatus_url + $.trim(srcid) + "/" + $.trim(dstid) + "/" + $.trim(insid);

    $.getJSON(url,function (data) {
        items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });
        items['id'] = id;
        gui_update(items, 0);
    });

}

function sleep(sleepTime) {
    for (var start = Date.now(); Date.now() - start <= sleepTime;) {}
}


function delete_task(taskid) {
    console.log("delete_task() is called.");

    url = remove_task_url ;
    postdata = {
        tid:         taskid,
    }
    $.post(url, postdata, function (data) {
        items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });

        location.reload();
    });
}

///////////////////////////////////////////////////////
//
// return :
//   sucess :  ['Result': 'OK',    'tid'   : tid]
//
///////////////////////////////////////////////////////
function stop_tvd(id, taskid) {
    console.log("stop_tvd() is called.");
    tmp = taskid.split(':')
    srcid = tmp[0];
    dstid = tmp[1];
    insid = tmp[2];

    url = stop_url + $.trim(srcid) + "/" + $.trim(dstid) + "/" + $.trim(insid);

    $.getJSON(url,function (data) {
        items = [];
        $.each(data, function (key, val) {
            items[key] = val;
        });

        delete_task(taskid);
    });
}


function errorMsgBox(msg) {
    console.log(msg);
}

function startVD( ecid, taskid, id ) {
    if ( taskid == '' ) {
        items = create_tvd(id, ecid);
    } else {
        items = start_tvd(id, taskid);
    }
}

function show_in_browser( taskid ) {
    tmp = taskid.split(':')
    srcid = tmp[0];
    dstid = tmp[1];
    insid = tmp[2];

    url="/clc/api/1.0/rvd/display/" + $.trim(srcid) + "/" + $.trim(dstid) + "/" + $.trim(insid);
    var left = ($(window).width() / 2) - (1440 / 2);
    var top = ($(window).height() / 2) - (1024 / 2);
    window.open(url, '', 'height=1280,width=1400,left=' + left + ',top=' + top);
}

function show_in_tools( url ) {
    alert( url );
}


function gui_update(items, do2run) {
    console.log("gui_update() is called.");
    id       = items['id'];
    phase    = items['phase'];
    state    = items['state'];
    progress = items['progress'];
    taskid   = items['tid']
    prompt   = items['prompt'];
    errormsg = items['errormsg'];
    failed   = items['failed'];

    if (phase == 'preparing') {
        if ( state == 'init') {
            $('#run_'  + id).removeClass('disabled');
            $('#show_' + id).addClass('disabled');
            $('#stop_' + id).addClass('disabled');

            $('#progress_' + id).css('display', 'none');
            $('#error_msg_' + id).css('display', 'none');

            if (failed == 1) {
                $('#error_msg_' + id).text(errormsg);
                $('#error_msg_' + id).css('color',   'red');
                $('#error_msg_' + id).css('display', 'block');
            }
        }

        if (state == 'downloading' || state == "cloning") {
            $('#run_'  + id).addClass('disabled');
            $('#show_' + id).addClass('disabled');
            $('#stop_' + id).addClass('disabled');

            $('#progress_'    + id).css('display', 'block');
            $('#progressbar_' + id).css('width', progress + '%');
            $('#progressbar_' + id).text(progress + '%');

            $('#error_msg_' + id).text(prompt);
            $('#error_msg_' + id).css('color',   'blue');
            $('#error_msg_' + id).css('display', 'block');

            // start to get progress till it is done
            setTimeout( get_progress, timer_interval, id, taskid, do2run);
        }

        if (state == 'done') {
            $('#run_'  + id).removeClass('disabled');
            $('#show_' + id).addClass('disabled');
            $('#stop_' + id).addClass('disabled');

            $('#progress_' + id).css('display', 'none');
            $('#error_msg_' + id).css('display', 'none');
            $('#error_msg_' + id).text('');

            if (do2run == 1) {
                setTimeout( run_tvd, timer_interval, id, taskid);
            }
        }
    }

    if ( phase == 'editing' ) {
        if (state == 'stopped') {
            $('#run_'  + id).removeClass('disabled');
            $('#show_' + id).addClass('disabled');
            $('#stop_' + id).addClass('disabled');

            $('#progress_' + id).css('display', 'none');
            $('#error_msg_' + id).css('display', 'none');

             if (failed == 1) {
                $('#error_msg_' + id).text(errormsg);
                $('#error_msg_' + id).css('color',   'red');
                $('#error_msg_' + id).css('display', 'block');
            }
        }

        if (state == 'booting') {
            $('#run_'  + id).addClass('disabled');
            $('#show_' + id).addClass('disabled');
            $('#stop_' + id).addClass('disabled');

            $('#progress_' + id).css('display', 'none');

            $('#error_msg_' + id).text('{% trans "booting ... ..." %}');
            $('#error_msg_' + id).css('color',   'blue');
            $('#error_msg_' + id).css('display', 'block');

            // start to get vm status till it is running
            setTimeout( get_vmstatus, timer_interval, id, taskid);
        }

        if (state == 'running' || state == 'Running') {
            $('#run_'  + id).addClass('disabled');
            $('#show_' + id).removeClass('disabled');
            $('#stop_' + id).removeClass('disabled');

            $('#progress_' + id).css('display', 'none');
            $('#error_msg_' + id).css('display', 'none');
        }
    }
}

function init_GUI() {
    var data = {};
    {% for vd in vds %}
        {% if vd.tid == '' %}
            $('#show_{{ vd.id }}').removeClass('disabled');
            $('#show_{{ vd.id }}').addClass('disabled');
            $('#stop_{{ vd.id }}').addClass('disabled');
        {% else %}
            data['id']      = '{{ vd.id }}'
            data['phase']   = '{{ vd.phase }}';
            data['state']   = '{{ vd.state}}';
            data['tid']     = '{{ vd.tid }}',
            data['promt']   = '';
            data['errormsg']= '';
            data['failed']  = 0;
            data['progress']= 0;

            gui_update(data, 0);
        {% endif %}
    {% endfor%}
}

$(document).ready(function () {
     init_GUI();
});
</script>

{% endblock %}